<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="#{title.listing}">Просмотр объявления | WorkSwap</title>
    <link href="/css/public/pages/listing-page.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="icon" href="/favicon.ico">
</head>
<body>
<header>
    <div class="container">
        <nav class="navbar">
            <a class="navbar-brand" href="/catalog" th:text="#{brand}">WorkSwap</a>
            <button class="navbar-toggler">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="navbar-collapse">
                <div class="d-flex">
                    <!-- Для неавторизованных пользователей -->
                    <div th:unless="${isAuthenticated}">
                        <a href="/login" class="btn btn-outline-primary" th:text="#{header.login}">Вход</a>
                        <a href="/register" class="btn btn-primary" th:text="#{header.register}">Регистрация</a>
                    </div>

                    <!-- Для авторизованных пользователей -->
                    <div th:if="${isAuthenticated}" class="account-info">
                        <a th:href="@{/secure/account}" class="account-link">
                            <img th:src="${avatarUrl}"
                                 class="account-avatar"
                                 alt="Аватар"
                                 th:onerror="this.src='/images/avatar-placeholder.jpg'">
                            <span th:text="${userName}">Пользователь</span>
                        </a>
                    </div>
                </div>
            </div>
        </nav>
    </div>
</header>

<!-- Основной контент -->
<div class="listing-container">
    <div class="listing-layout">
        <!-- Основное содержимое -->
        <main class="listing-main">
            <!-- Хлебные крошки -->
            <nav class="breadcrumbs">
                <a href="/catalog" th:text="#{breadcrumbs.catalog}">Каталог</a>
                <span> / </span>
                <a th:href="@{/catalog(category=${listing.category})}">
                    <span th:switch="${listing.category}">
                        <span th:case="'services'" th:text="#{category.service}">Услуга</span>
                        <span th:case="'product'" th:text="#{category.product}">Товар</span>
                        <span th:case="'offer-service'" th:text="#{category.offer-service}">Запрос на услугу3</span>
                    </span>
                </a>
                <span> / </span>
                <span th:text="${listing.localizedTitle}">Название объявления</span>
            </nav>


            <!-- Заголовок объявления -->
            <div class="listing-header">
                <h1 th:text="${listing.localizedTitle}">Название объявления</h1>
                <div class="listing-meta">
                    <span class="listing-date" th:text="${#temporals.format(listing.createdAt, 'dd.MM.yyyy')}">01.01.2023</span>
                    <span class="listing-views">Просмотры: <span th:text="${listing.views}">0</span></span>
                </div>
            </div>

            <!-- Галерея изображений -->
            <div class="listing-gallery">
                <div class="main-image">
                    <img th:src="@{'/' + ${listing.imagePath}}"
                         th:onerror="this.src='/images/default-listing.png'"
                         alt="Основное изображение"
                         class="clickable-image" th:data-fullscreen="@{'/' + ${listing.imagePath}}">
                </div>
                <div class="thumbnails" th:if="${listing.images != null and !listing.images.isEmpty()}">
                    <div class="thumbnail" th:each="image : ${listing.images}">
                        <img th:src="@{'/' + ${image.path}}"
                             th:onerror="this.src='/images/default-listing.png'"
                             alt="Дополнительное изображение"
                             class="clickable-image" data-fullscreen="@{'/' + ${image.path}}">
                    </div>
                </div>
            </div>
            <div id="fullscreen-modal" class="fullscreen-modal">
                <span class="close" id="close-modal">&times;</span>
                <img id="fullscreen-image" src="" alt='/images/default-listing.png'>
            </div>

            <!-- Информация о предложении -->
            <div class="listing-content">
                <div class="listing-details">
                    <h2 th:text="#{listing.description}">Описание</h2>
                    <p class="listing-description"
                       th:text="${listing.localizedDescription ?: 'Нет описания'}">
                        Полное описание услуги или предложения.
                    </p>

                    <div class="details-grid">
                        <div class="detail-item">
                            <span class="detail-label" th:text="#{listing.price}">Цена:</span>
                            <span class="price" th:switch="${listing.priceType}">
                                <span th:case="'negotiable'" th:text="#{price.negotiable}">Договорная</span>
                                <span th:case="'per_hour'" th:text="${listing.price} + ' ' + #{price.per-hour}">Цена</span>
                                <span th:case="'per_day'" th:text="${listing.price} + ' ' + #{price.per-day}">Цена</span>
                                <span th:case="'fixed'" th:text="${listing.price} + ' ' + #{price.fixed}">Цена</span>
                                <span th:case="*">Цена не указана</span>
                            </span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label" th:text="#{listing.location}">Локация:</span>
                            <span class="detail-value" th:text="${listing.location ?: 'Хельсинки'}">Хельсинки</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label" th:text="#{listing.category}">Категория:</span>
                            <span th:switch="${listing.category}">
                                <span th:case="'services'" th:text="#{category.service}">Услуга</span>
                                <span th:case="'product'" th:text="#{category.product}">Товар</span>
                                <span th:case="'offer-service'" th:text="#{category.offer-service}">Запрос на услугу3</span>
                            </span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label" th:text="#{listing.rating}">Рейтинг:</span>
                            <span class="detail-value rating">
                                <th:block th:each="i : ${#numbers.sequence(1,5)}">
                                    <i class="fa"
                                       th:classappend="${listing.averageRating >= i} ? 'fa-star' :
                                       (${listing.averageRating >= i - 0.5} ? 'fa-star-half-o' : 'fa-star-o')">
                                    </i>
                                </th:block>
                            </span>
                        </div>
                    </div>

                    <div class="listing-features" th:if="${listing.features != null and !listing.features.isEmpty()}">
                        <h3 th:text="#{listing.features}">Особенности</h3>
                        <ul class="features-list">
                            <li th:each="feature : ${listing.features}"
                                th:text="${feature ?: 'Особенность'}">
                                Быстрое выполнение
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Боковая панель с контактами -->
                <aside class="listing-sidebar">
                    <div class="seller-card" th:if="${listing.author != null}">
                        <div class="seller-avatar">
                            <img th:src="@{${authorAvatarPath}}"
                                 th:onerror="this.src='/images/default-avatar.png'"
                                 alt="Аватар продавца">
                        </div>
                        <div class="seller-info">
                            <h4 th:text="${listing.author.name ?: 'Неизвестный автор'}">Иван Иванов</h4>
                            <div class="seller-rating">
                                <span th:text="#{listing.rating}">Рейтинг: </span>
                                <span th:text="${listing.author.averageRating}">4.5</span> ★
                            </div>
                            <div class="seller-stats">
                                <span th:text="${listing.author.completedJobs != null ? listing.author.completedJobs : '0'}">0</span>
                            </div>
                        </div>
                        <div class="seller-actions">
                            <div th:if="${isAuthenticated}">
                                <!-- Показываем кнопки только если пользователь не владелец -->
                                <div th:unless="${isOwner}">
                                    <form action="/secure/messenger/chat" method="get">
                                        <input type="hidden" name="sellerId" th:value="${listing.author.id}">
                                        <input type="hidden" name="listingId" th:value="${listing.id}">
                                        <button type="submit" class="btn btn-primary" th:text="#{listing.write}">Написать сообщение</button>
                                    </form>
                                    <form th:action="@{/listing/{id}/favorite(id=${listing.id})}" method="post" style="display: inline;">
                                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                        <button type="submit" class="btn btn-outline-primary"
                                                th:text="${isFavorite} ? #{listing.favorite.remove} : #{listing.favorite.add}">
                                        </button>
                                    </form>
                                </div>

                                <!-- Можно добавить кнопки для владельца -->
                                <a th:href="@{'/secure/listing/edit/' + ${listing.id}}"
                                   class="btn btn-primary"
                                   th:if="${isOwner}" th:text="#{listing.edit}">Редактировать</a>
                            </div>
                            <div th:unless="${isAuthenticated}">
                                <a href="/login" class="btn btn-primary" th:text="#{login.to.write}">Войти, чтобы написать</a>
                            </div>
                        </div>
                    </div>

                    <div class="contact-card" th:if="${listing.author != null}">
                        <h3 th:text="#{listing.author.contacts}">Контактная информация</h3>
                        <div class="contact-methods">
                            <div class="contact-item">
                                <span class="contact-icon">📱</span>
                                <span th:text="${listing.author.phoneVisible ? (listing.author.phone != null ? listing.author.phone : 'Не указан') : 'Скрыто'}">Не указан</span>
                            </div>
                            <div class="contact-item">
                                <span class="contact-icon">✉️</span>
                                <span class="contact-value"
                                      th:text="${listing.author.emailVisible ? (listing.author.email != null ? listing.author.email : 'Не указан') : 'Скрыто'}">Не указан</span>
                            </div>
                        </div>
                    </div>

                </aside>
            </div>

            <!-- Отзывы -->
            <section class="reviews-section" th:if="${listing.reviews != null and !listing.reviews.isEmpty()}">
                <h2 th:text="#{reviews.title}">Отзывы</h2>
                <div class="reviews-list">
                    <article th:each="review : ${listing.reviews}" class="review-card">
                        <div class="review-header">
                            <div class="reviewer-avatar">
                                <img th:src="@{${reviewAuthorAvatars[review.id]}}"
                                     onerror="this.src='/images/avatar-placeholder.jpg'"
                                     alt="Reviewer Avatar">
                            </div>
                            <div class="reviewer-info">
                                <h4 th:text="${review.author.name ?: 'Аноним'}">Алексей Петров</h4>
                                <div class="review-meta">
                                    <span class="review-rating listing-rating">
                                        <th:block th:each="i : ${#numbers.sequence(1,5)}">
                                            <i class="fa"
                                               th:classappend="${review.rating >= i} ? 'fa-star' : (${review.rating >= i - 0.5} ? 'fa-star-half-o' : 'fa-star-o')"></i>
                                        </th:block>
                                    </span>
                                    <span class="review-date"
                                          th:text="${#temporals.format(review.createdAt, 'dd.MM.yyyy')}">15.03.2023</span>
                                </div>
                            </div>
                        </div>
                        <div class="review-content">
                            <p th:text="${review.text ?: 'Нет текста отзыва'}">Отличный специалист, быстро и качественно выполнил работу. Рекомендую!</p>
                        </div>
                    </article>
                </div>
            </section>

            <!-- Форма для добавления нового отзыва -->
            <!-- Форма для добавления нового отзыва -->
            <section class="review-form" th:if="${isAuthenticated}">
                <h3 th:text="#{reviews.leave_review}">Оставьте свой отзыв</h3>
                <form th:action="@{/listing/{id}/review(id=${listing.id})}" method="post">
                    <div class="form-row">
                        <div class="rating-group">
                            <label for="rating" th:text="#{reviews.rating}">Оценка</label>
                            <div class="listing-rating">
                                <span class="star" data-value="1">&#9733;</span>
                                <span class="star" data-value="2">&#9733;</span>
                                <span class="star" data-value="3">&#9733;</span>
                                <span class="star" data-value="4">&#9733;</span>
                                <span class="star" data-value="5">&#9733;</span>
                                <input type="hidden" id="rating" name="rating" value="0"> <!-- скрытое поле для отправки значения -->
                            </div>
                        </div>
                        <div class="text-group">
                            <label for="text" th:text="#{reviews.placeholder_text}">Текст отзыва</label>
                            <textarea id="text" name="text" required></textarea>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary" th:text="#{reviews.button.enter}">Оставить отзыв</button>
                </form>
            </section>

            <!-- Если пользователь не аутентифицирован -->
            <section class="login-prompt" th:if="${!isAuthenticated}">
                <p>
                    <span th:text="#{login_prompt.message}"></span>
                    <a href="/login" th:text="#{login_prompt.message.login}">войти в систему</a></p>
            </section>


            <!-- Похожие объявления -->
            <section class="similar-listings" th:if="${similarListings != null and !similarListings.isEmpty()}">
                <h2 th:text="#{similar_listings.title}">Похожие объявления</h2>
                <div class="listings-grid">
                    <article th:each="similarListing : ${similarListings}" class="listing-card"
                             th:if="${similarListing.localizedTitle != null and similarListing.localizedDescription != null}">
                        <a th:href="@{/listing/{id}(id=${similarListing.id})}">
                            <img th:src="@{${similarListing.imagePath ?: '/images/default-listing.png'}}"
                                 class="listing-img"
                                 alt="Изображение объявления">
                        </a>
                        <div class="card-body">
                            <h3 class="card-title">
                                <a th:href="@{/listing/{id}(id=${similarListing.id})}"
                                   th:text="${similarListing.localizedTitle}">
                                    Название
                                </a>
                            </h3>
                            <p class="card-text"
                               th:text="${#strings.length(similarListing.localizedDescription) > 100} ?
                            ${#strings.substring(similarListing.localizedDescription, 0, 100)} + '...' :
                            ${similarListing.localizedDescription}">
                                Описание
                            </p>
                            <div class="card-footer">
                                <div>
                        <span class="price" th:switch="${similarListing.priceType}">
                            <span th:case="'negotiable'" th:text="#{price.negotiable}">Договорная</span>
                            <span th:case="'per_hour'" th:text="${similarListing.price} + ' ' + #{price.per-hour}">Цена</span>
                            <span th:case="'per_day'" th:text="${similarListing.price} + ' ' + #{price.per-day}">Цена</span>
                            <span th:case="'fixed'" th:text="${similarListing.price} + ' ' + #{price.fixed}">Цена</span>
                            <span th:case="*">Цена не указана</span>
                        </span>
                                    <div class="listing-rating">
                                        <th:block th:each="i : ${#numbers.sequence(1,5)}">
                                            <i class="fa"
                                               th:classappend="${similarListing.averageRating >= i} ? 'fa-star' :
                                                    (${similarListing.averageRating >= i - 0.5} ? 'fa-star-half-o' : 'fa-star-o')"></i>
                                        </th:block>
                                    </div>
                                </div>
                                <span class="location" th:text="${similarListing.location ?: 'Хельсинки'}">
                        Локация
                    </span>
                            </div>
                        </div>
                    </article>
                </div>
            </section>
        </main>
    </div>
</div>
<div class="language-toggle">
    <input type="checkbox" id="langToggle">
    <label for="langToggle" class="lang-wrapper">
        <!-- Основная кнопка с текущим языком -->
        <div class="lang-button">
            <img th:src="@{/images/flags/__${#locale.language}__.png}" alt="Current language" class="flag-icon">
        </div>

        <!-- Выпадающий список языков -->
        <div class="lang-dropdown">
            <a href="?lang=ru" th:classappend="${#locale.language == 'ru'} ? 'active'">
                <img src="/images/flags/ru.png" alt="RU" class="flag-icon">
                <span>Русский</span>
            </a>
            <a href="?lang=fi" th:classappend="${#locale.language == 'fi'} ? 'active'">
                <img src="/images/flags/fi.png" alt="FI" class="flag-icon">
                <span>Suomi</span>
            </a>
            <a href="?lang=en" th:classappend="${#locale.language == 'en'} ? 'active'">
                <img src="/images/flags/en.png" alt="EN" class="flag-icon">
                <span>English</span>
            </a>
        </div>
    </label>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Мобильное меню
    document.querySelector('.navbar-toggler').addEventListener('click', function() {
        document.querySelector('.navbar-collapse').classList.toggle('show');
    });
    // Получаем все изображения, по которым будет открываться полный экран
    const images = document.querySelectorAll('.clickable-image');
    const modal = document.getElementById('fullscreen-modal');
    const fullscreenImage = document.getElementById('fullscreen-image');
    const closeModal = document.getElementById('close-modal');

    // Функция для открытия модального окна
    images.forEach(image => {
        image.addEventListener('click', function() {
            const imageUrl = this.getAttribute('data-fullscreen');
            fullscreenImage.src = imageUrl;
            modal.classList.add('show');
        });
    });

    // Закрытие модального окна
    closeModal.addEventListener('click', function() {
        modal.classList.remove('show');
    });

    // Закрытие модального окна при клике за его пределами
    modal.addEventListener('click', function(event) {
        if (event.target === modal) {
            modal.classList.remove('show');
        }
    });
</script>
<script>
    // Юхууу, звёздочки :)
    document.querySelectorAll('.star').forEach(function(star) {
        star.addEventListener('mouseover', function() {
            let value = parseInt(star.getAttribute('data-value'));
            document.querySelectorAll('.star').forEach(function(s) {
                s.classList.remove('selected');
                if (parseInt(s.getAttribute('data-value')) <= value) {
                    s.classList.add('selected');
                }
            });
        });

        star.addEventListener('click', function() {
            let value = parseInt(star.getAttribute('data-value'));
            document.getElementById('rating').value = value;
        });

        star.addEventListener('mouseout', function() {
            let value = document.getElementById('rating').value;
            document.querySelectorAll('.star').forEach(function(s) {
                s.classList.remove('selected');
                if (parseInt(s.getAttribute('data-value')) <= value) {
                    s.classList.add('selected');
                }
            });
        });
    });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.2/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script src="/js/websocket-global.js"></script>
</body>
</html>